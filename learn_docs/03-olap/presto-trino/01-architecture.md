# Presto/Trino 架构详解

## 目录

- [概述](#概述)
- [核心概念](#核心概念)
- [架构原理](#架构原理)
- [查询处理](#查询处理)
- [连接器](#连接器)

---

## 概述

Presto/Trino 是一个分布式 SQL 查询引擎，专为大数据分析设计。

### 核心特性

| 特性 | 说明 |
|------|------|
| **交互式查询** | 秒级响应 |
| **多数据源** | 联邦查询 |
| **高并发** | 并行处理 |
| **标准 SQL** | 完整 SQL 支持 |
| **水平扩展** | 线性扩展 |

---

## 核心概念

### 核心术语

```
┌─────────────────────────────────────────────────────────────────┐
│                    Presto 核心概念                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Coordinator   │  协调器，查询调度                              │
│  Worker        │  工作节点，执行任务                            │
│  Connector     │  连接器，数据源适配                            │
│  Catalog       │  目录，数据源实例                              │
│  Schema        │  模式                                          │
│  Table         │  表                                            │
│  Stage         │  执行阶段                                      │
│  Task          │  任务                                          │
│  Split         │  数据分片                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 架构原理

### 集群架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    Presto 集群架构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Coordinator                           │   │
│  │  ┌───────────────────────────────────────────────────┐  │   │
│  │  │  Parser  │  Analyzer  │  Planner  │  Scheduler   │  │   │
│  │  └───────────────────────────────────────────────────┘  │   │
│  │  - SQL 解析                                              │   │
│  │  - 查询计划                                              │   │
│  │  - 任务调度                                              │   │
│  │  - 结果返回                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                               │                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Worker (多个)                         │   │
│  │  ┌───────────────────────────────────────────────────┐  │   │
│  │  │  Task 1  │  Task 2  │  Task 3  │  Task 4         │  │   │
│  │  └───────────────────────────────────────────────────┘  │   │
│  │  - 数据处理                                              │   │
│  │  - Shuffle                                              │   │
│  │  - 内存管理                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                               │                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Discovery Service                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 查询处理

### 查询流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    Presto 查询流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 客户端提交 SQL 到 Coordinator                                │
│  2. Parser 解析 SQL                                             │
│  3. Analyzer 验证语义                                           │
│  4. Planner 生成逻辑计划                                        │
│  5. 优化器生成物理计划                                          │
│  6. Scheduler 调度执行                                          │
│  7. Worker 并行执行任务                                          │
│  8. 结果返回客户端                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 执行模型

```
┌─────────────────────────────────────────────────────────────────┐
│                    执行计划层级                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Fragment 0 (Root)                                             │
│  └─ Output                                                     │
│                                                                 │
│  Fragment 1                                                    │
│  └─ Project → Filter → Exchange                                │
│                                                                 │
│  Fragment 2                                                    │
│  └─ Aggregation → Exchange                                     │
│                                                                 │
│  Fragment 3                                                    │
│  └─ TableScan (Connector)                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 相关文档

| 文档 | 说明 |
|------|------|
| [02-connector.md](02-connector.md) | 连接器配置 |
| [03-query-guide.md](03-query-guide.md) | 查询指南 |
| [04-performance.md](04-performance.md) | 性能优化 |
| [README.md](README.md) | 索引文档 |
