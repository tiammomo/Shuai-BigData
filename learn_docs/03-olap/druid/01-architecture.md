# Apache Druid 架构详解

## 目录

- [概述](#概述)
- [核心概念](#核心概念)
- [架构原理](#架构原理)
- [数据模型](#数据模型)
- [查询处理](#查询处理)

---

## 概述

Apache Druid 是一个实时分析数据库，专为 OLAP 设计。

### 核心特性

| 特性 | 说明 |
|------|------|
| **实时摄入** | 秒级数据可见 |
| **高并发** | 低延迟查询 |
| **水平扩展** | 分布式架构 |
| **多维分析** | 丰富聚合函数 |
| **云原生** | 支持 Kubernetes |

---

## 核心概念

### 核心术语

```
┌─────────────────────────────────────────────────────────────────┐
│                    Druid 核心概念                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  DataSource    │  数据源，逻辑表                                │
│  Dimension     │  维度列，用于分组                              │
│  Metric        │  指标列，用于聚合                              │
│  Segment       │  数据段，存储单元                              │
│  Granularity   │  时间粒度                                      │
│  Rollup        │  预聚合                                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 架构原理

### 集群架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    Druid 集群架构                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Coordinator                           │   │
│  │  - 段分配                                                │   │
│  │  - 负载均衡                                              │   │
│  │  - 副本管理                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Overlord                             │   │
│  │  - 任务调度                                              │   │
│  │  - 吸入管理                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Broker                                │   │
│  │  - 查询路由                                              │   │
│  │  - 结果合并                                              │   │
│  │  - 缓存管理                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Historical                            │   │
│  │  - 存储段                                                │   │
│  │  - 服务查询                                              │   │
│  │  - 副本同步                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    MiddleManager                         │   │
│  │  - 任务执行                                              │   │
│  │  - Peon 管理                                             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    ZooKeeper                             │   │
│  │  - 服务发现                                              │   │
│  │  - 选举                                                  │   │
│  │  - 协调                                                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 相关文档

| 文档 | 说明 |
|------|------|
| [02-data-operations.md](02-data-operations.md) | 数据操作 |
| [03-query-guide.md](03-query-guide.md) | 查询指南 |
| [README.md](README.md) | 索引文档 |
