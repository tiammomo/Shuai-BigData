# Apache Paimon 架构详解

## 目录

- [概述](#概述)
- [核心概念](#核心概念)
- [架构原理](#架构原理)
- [存储结构](#存储结构)
- [写入流程](#写入流程)

---

## 概述

Apache Paimon 是流式数据湖解决方案，提供实时数据湖能力。

### 核心特性

| 特性 | 说明 |
|------|------|
| **实时入湖** | CDC 实时同步，秒级延迟 |
| **流批一体** | 统一存储，统一查询 |
| **Schema 演进** | 灵活的 Schema 变更 |
| **时间旅行** | 历史版本查询 |
| **多引擎支持** | Flink / Spark / Trino |

---

## 核心概念

### 表类型

```
┌─────────────────────────────────────────────────────────────────┐
│                    Paimon 表类型                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Primary Key Table                     │   │
│  │  - 有主键，支持 UPSERT                                   │   │
│  │  - 自动去重                                              │   │
│  │  - 适合 CDC 数据同步                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Append Table                          │   │
│  │  - 无主键，仅支持 INSERT                                 │   │
│  │  - 追加写入                                              │   │
│  │  - 适合日志/事件数据                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Changelog Table                       │   │
│  │  - 保留完整变更记录                                      │   │
│  │  - 支持变更捕获                                          │   │
│  │  - 适合审计需求                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 核心术语

| 术语 | 说明 |
|------|------|
| **Bucket** | 数据分桶，相同键的数据在同一桶 |
| **Partition** | 分区，按时间/业务分区 |
| **Changelog Producer** | 变更记录生成器 |
| **Merge Engine** | 合并引擎 |
| **Compaction** | 文件合并 |

---

## 架构原理

### 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    Paimon 架构                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Compute Engines                       │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐                  │   │
│  │  │  Flink  │  │  Spark  │  │ Trino   │                  │   │
│  │  └─────────┘  └─────────┘  └─────────┘                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Paimon Core                          │   │
│  │  ┌───────────────────────────────────────────────────┐  │   │
│  │  │  Catalog Manager                                   │  │   │
│  │  │  - 元数据管理                                       │  │   │
│  │  │  - Schema 管理                                     │  │   │
│  │  └───────────────────────────────────────────────────┘  │   │
│  │  ┌───────────────────────────────────────────────────┐  │   │
│  │  │  Write Interface                                   │  │   │
│  │  │  - Record Writer                                   │  │   │
│  │  │  - Commit Protocol                                 │  │   │
│  │  └───────────────────────────────────────────────────┘  │   │
│  │  ┌───────────────────────────────────────────────────┐  │   │
│  │  │  Read Interface                                    │  │   │
│  │  │  - File Index                                      │  │   │
│  │  │  - Manifest Cache                                  │  │   │
│  │  └───────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Storage Layer                         │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐                  │   │
│  │  │  HDFS   │  │   S3    │  │  OSS    │                  │   │
│  │  └─────────┘  └─────────┘  └─────────┘                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Catalog 架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    Catalog 架构                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Filesystem Catalog                    │   │
│  │  - 元数据存储在文件系统                                    │   │
│  │  - 轻量级，适合小规模                                      │   │
│  │  - 配置: warehouse = 'hdfs://...'                        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Hive Metastore                        │   │
│  │  - 元数据存储在 Hive Metastore                           │   │
│  │  - 兼容 Hive 生态                                         │   │
│  │  - 配置: metastore = 'hive'                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    JDBC Catalog                          │   │
│  │  - 元数据存储在数据库                                      │   │
│  │  - 支持 MySQL, PostgreSQL                                │   │
│  │  - 配置: jdbc.url = 'jdbc:mysql://...'                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 存储结构

### 文件布局

```
warehouse/
└── database/
    └── table/
        ├── manifest/
        │   ├── manifest-list-xxx
        │   └── manifest-file-xxx
        ├── snapshot/
        │   ├── snapshot-xxx
        │   └── snapshot-xxx.inprogress
        ├── data/
        │   ├── bucket-0/
        │   │   ├── manifest-xxx
        │   │   └── data-xxx.parquet
        │   └── bucket-1/
        └── schema/
            └── schema-xxx
```

### 文件类型

| 文件类型 | 说明 | 格式 |
|---------|------|------|
| **Manifest** | 文件清单 | AVRO |
| **Snapshot** | 快照信息 | JSON |
| **Data File** | 数据文件 | Parquet/ORC |
| **Schema** | Schema 信息 | JSON |

---

## 写入流程

### 流式写入

```java
// Flink Sink
Table table = catalog.getTable("my_db", "my_table");
BulkEncodeWriter<RowData> writer = table.newBulkEncodeWrite()
    .withCommittable("commit-uuid", 1)
    .withManifestCommittable(manifestCommittable)
    .write();

for (RowData row : input) {
    writer.write(row);
}

CommitResult result = writer.commit(commitContext);
```

### Changelog Producer

```sql
-- 无 Changelog
CREATE TABLE t1 (...) WITH ('changelog-producer' = 'none');

-- 输入变更 (推荐用于 CDC)
CREATE TABLE t2 (...) WITH ('changelog-producer' = 'input');

-- 完整变更
CREATE TABLE t3 (...) WITH ('changelog-producer' = 'full-compaction');

-- 重复合并
CREATE TABLE t4 (...) WITH ('changelog-producer' = 'lookup');
```

### 合并引擎

```sql
-- 仅保留第一条
CREATE TABLE t1 (...) WITH ('merge-engine' = 'first-row');

-- 聚合合并
CREATE TABLE t2 (...) WITH ('merge-engine' = 'aggregation');

-- 部分更新
CREATE TABLE t3 (...) WITH ('merge-engine' = 'partial-update');

-- 去重合并
CREATE TABLE t4 (...) WITH ('merge-engine' = 'deduplicate');
```

---

## 相关文档

| 文档 | 说明 |
|------|------|
| [02-usage.md](02-usage.md) | 使用指南 |
| [README.md](README.md) | 索引文档 |
