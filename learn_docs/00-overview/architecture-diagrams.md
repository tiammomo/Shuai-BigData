# 大数据架构图

本文档展示大数据平台的整体架构、数据流和组件集成关系。

## 1. 整体架构概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           数据采集层 (Data Ingestion)                         │
├─────────────┬─────────────┬─────────────┬─────────────┬─────────────────────┤
│   Logstash  │   Flume     │   Filebeat  │   CDC (Flink│   Kafka Connect    │
│             │             │             │   CDC/DataX │                     │
└──────┬──────┴──────┬──────┴──────┬──────┴──────┬──────┴──────────┬──────────┘
       │             │             │             │                 │
       └─────────────┴─────────────┴─────────────┴─────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         消息队列层 (Message Queue)                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                         Apache Kafka                                 │    │
│  │    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐   │    │
│  │    │  Topic   │    │  Topic   │    │  Topic   │    │  Topic   │   │    │
│  │    │  raw     │    │  ods     │    │  dwd     │    │  dws     │   │    │
│  │    └──────────┘    └──────────┘    └──────────┘    └──────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    │                 │                 │
                    ▼                 ▼                 ▼
┌─────────────────────────┐ ┌─────────────────────────┐ ┌─────────────────────────┐
│    实时计算 (Real-time)  │ │   批处理 (Batch)        │ │  机器学习 (ML Pipeline) │
│  ┌───────────────────┐  │ │ ┌───────────────────┐  │ │ ┌───────────────────┐  │
│  │   Apache Flink    │  │ │ │   Apache Spark    │  │ │ │   Spark MLlib     │  │
│  │  ┌─────────────┐  │  │ │ │  ┌─────────────┐  │  │ │ │   TensorFlow     │  │
│  │  │ Stream API  │  │  │ │ │  │  RDD/Data   │  │  │ │ │   MLflow         │  │
│  │  │ Table/SQL   │  │  │ │ │  │  Frame      │  │  │ │ │                   │  │
│  │  │ CEP         │  │  │ │ │  │  MLlib      │  │  │ │ │                   │  │
│  │  └─────────────┘  │  │ │ │  └─────────────┘  │  │ │ │                   │  │
│  │                   │  │ │ │                   │  │ │ │                   │  │
│  │  Flink SQL        │  │ │ │  Spark SQL        │  │ │ │                   │  │
│  │  State Backend    │  │ │ │  Structured       │  │ │ │                   │  │
│  │  Checkpoint       │  │ │ │  Streaming        │  │ │ │                   │  │
│  └───────────────────┘  │ │ └───────────────────┘  │ │ └───────────────────┘  │
└─────────────────────────┘ └─────────────────────────┘ └─────────────────────────┘
                    │                 │                 │
                    └─────────────────┼─────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        数据服务层 (Data Serving)                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                           OLAP 引擎                                  │    │
│  │                                                                     │    │
│  │    ┌─────────────────┐         ┌─────────────────┐                 │    │
│  │    │   ClickHouse    │         │   Apache Doris  │                 │    │
│  │    │                 │         │                 │                 │    │
│  │    │  MergeTree      │         │  Unique/Merge   │                 │    │
│  │    │  Aggregating    │         │  Aggregate      │                 │    │
│  │    │  Replacing      │         │  Duplicate      │                 │    │
│  │    └─────────────────┘         └─────────────────┘                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          数据应用层 (Data Application)                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────┐   │
│  │  数据报表 │  │  实时大屏 │  │  BI 工具 │  │  API 服务 │  │  数据可视化  │   │
│  │  Dashboard│  │  Realtime│  │          │  │  Data API │  │  Grafana     │   │
│  │          │  │  Screen  │  │          │  │          │  │  Superset    │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 2. 流处理架构 (Flink)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Flink 流处理架构                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │
│  │   Data      │    │   Source    │    │  Transform  │    │   Sink      │  │
│  │   Source    │───▶│   (Kafka)   │───▶│   Operators │───▶│   (Storage) │  │
│  │             │    │             │    │             │    │             │  │
│  │  ┌─────────┐│    └─────────────┘    ┌─────────────┐    └─────────────┘  │
│  │  │ Socket  ││                         │             │                    │
│  │  │ Files   ││                         ▼             ▼                    │
│  │  │ JDBC    ││              ┌─────────────┐   ┌─────────────┐            │
│  │  │ Kinesis ││              │   Window    │   │   Process   │            │
│  │  │ Redis   ││              │  Operations │   │  Functions  │            │
│  │  └─────────┘│              │             │   │             │            │
│  └─────────────┘              │  Tumbling   │   │  Map/FlatMap│            │
│                               │  Sliding    │   │  Filter     │            │
│                               │  Session    │   │  KeyBy      │            │
│                               │  Global     │   │  Reduce     │            │
│                               └─────────────┘   └─────────────┘            │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                           状态管理 & 容错                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────┐  │    │
│  │  │   Checkpoint    │  │   Savepoint     │  │   State Backend     │  │    │
│  │  │                 │  │                 │  │                     │  │    │
│  │  │  - Barrier      │  │  - Manual trigger│ │  - HashMap          │  │    │
│  │  │  - Exactly-Once │  │  - Portable      │ │  - RocksDB          │  │    │
│  │  │  - Periodic     │  │  - Upgrade/Migar │ │  - Distributed      │  │    │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 3. 批处理架构 (Spark)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Spark 批处理架构                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                         ┌───────────────────┐                               │
│                         │   Spark Submit    │                               │
│                         │   / spark-shell   │                               │
│                         └─────────┬─────────┘                               │
│                                   │                                         │
│                                   ▼                                         │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                         Spark Application                            │   │
│  │                                                                      │   │
│  │    ┌──────────────────────────────────────────────────────────┐     │   │
│  │    │                    Spark Context                          │     │   │
│  │    │                   (Driver Program)                        │     │   │
│  │    │                                                          │     │   │
│  │    │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │     │   │
│  │    │  │ Spark    │  │ SQL/     │  │ MLlib    │  │ GraphX   │ │     │   │
│  │    │  │ Core     │  │ Dataset  │  │          │  │          │ │     │   │
│  │    │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘ │     │   │
│  │    │       │             │             │             │       │     │   │
│  │    │       └─────────────┴──────┬──────┴─────────────┘       │     │   │
│  │    │                            │                            │     │   │
│  │    │                            ▼                            │     │   │
│  │    │                  ┌──────────────────┐                   │     │   │
│  │    │                  │      RDD         │                   │     │   │
│  │    │                  │  (Resilient      │                   │     │   │
│  │    │                  │   Distributed    │                   │     │   │
│  │    │                  │   Dataset)       │                   │     │   │
│  │    │                  └──────────────────┘                   │     │   │
│  │    └──────────────────────────────────────────────────────────┘     │   │
│  │                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                   │                                         │
│                                   ▼                                         │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                    Spark Cluster Manager                              │   │
│  │                                                                      │   │
│  │         ┌──────────┐   ┌──────────┐   ┌──────────┐                  │   │
│  │         │  Stand-  │   │   YARN   │   │  Mesos   │   │  K8s        │   │
│  │         │  alone   │   │          │   │          │   │             │   │
│  │         └──────────┘   └──────────┘   └──────────┘   └──────────┘   │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                   │                                         │
│                                   ▼                                         │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                    Worker Nodes (Executors)                          │   │
│  │                                                                      │   │
│  │   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────────────┐ │   │
│  │   │  Node 1  │   │  Node 2  │   │  Node 3  │   │      ...         │ │   │
│  │   │          │   │          │   │          │   │                  │ │   │
│  │   │ ┌──────┐ │   │ ┌──────┐ │   │ ┌──────┐ │   │   ┌──────────┐   │ │   │
│  │   │ │Cores │ │   │ │Cores │ │   │ │Cores │ │   │   │Cores     │   │ │   │
│  │   │ │Memory│ │   │ │Memory│ │   │ │Memory│ │   │   │Memory    │   │ │   │
│  │   │ └──────┘ │   │ └──────┘ │   │ └──────┘ │   │   └──────────┘   │ │   │
│  │   └──────────┘   └──────────┘   └──────────┘   └──────────────────┘ │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 4. Kafka 集群架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Kafka 集群架构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                              ┌─────────────┐                                │
│                              │   Producer  │                                │
│                              │   Clients   │                                │
│                              └──────┬──────┘                                │
│                                     │                                       │
│             ┌───────────────────────┼───────────────────────┐               │
│             │                       │                       │               │
│             ▼                       ▼                       ▼               │
│  ┌──────────────────┐   ┌──────────────────┐   ┌──────────────────┐        │
│  │     Broker 1     │   │     Broker 2     │   │     Broker N     │        │
│  │                  │   │                  │   │                  │        │
│  │  ┌────────────┐  │   │  ┌────────────┐  │   │  ┌────────────┐  │        │
│  │  │ Topic: log │  │   │  │ Topic: log │  │   │  │ Topic: log │  │        │
│  │  │ Partition 0│  │   │  │ Partition 1│  │   │  │ Partition N│  │        │
│  │  │ (Leader)   │  │   │  │ (Leader)   │  │   │  │ (Leader)   │  │        │
│  │  └────────────┘  │   │  └────────────┘  │   │  └────────────┘  │        │
│  │                  │   │                  │   │                  │        │
│  │  ┌────────────┐  │   │  ┌────────────┐  │   │  ┌────────────┐  │        │
│  │  │ Topic: app │  │   │  │ Topic: app │  │   │  │ Topic: app │  │        │
│  │  │ Partition 0│  │   │  │ Partition 1│  │   │  │ Partition N│  │        │
│  │  │ (Follower) │  │   │  │ (Follower) │  │   │  │ (Follower) │  │        │
│  │  └────────────┘  │   │  └────────────┘  │   │  └────────────┘  │        │
│  └────────┬─────────┘   └────────┬─────────┘   └────────┬─────────┘        │
│           │                      │                      │                   │
│           └──────────────────────┼──────────────────────┘                   │
│                                  │                                          │
│                    ┌─────────────┼─────────────┐                            │
│                    │             │             │                            │
│                    ▼             ▼             ▼                            │
│           ┌──────────────┐ ┌──────────────┐ ┌──────────────┐               │
│           │   Zookeeper  │ │  Zookeeper   │ │  Zookeeper   │               │
│           │    Node 1    │ │    Node 2    │ │    Node 3    │               │
│           └──────────────┘ └──────────────┘ └──────────────┘               │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                         Topic Partition 分布                                │
│                                                                             │
│   Topic: my-topic (3 partitions, replication-factor: 3)                     │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   Partition 0          Partition 1          Partition 2             │   │
│   │   ┌─────────┐          ┌─────────┐          ┌─────────┐            │   │
│   │   │ Broker1 │ Leader   │ Broker2 │ Leader   │ Broker3 │ Leader    │   │
│   │   │         │          │         │          │         │           │   │
│   │   │ Broker2 │ Follower │ Broker3 │ Follower │ Broker1 │ Follower  │   │
│   │   │ Broker3 │ Follower │ Broker1 │ Follower │ Broker2 │ Follower  │   │
│   │   └─────────┘          └─────────┘          └─────────┘            │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 5. OLAP 架构 (ClickHouse / Doris)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         OLAP 数据仓库架构                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                          数据分层 (Lambda Architecture)              │    │
│  │                                                                     │    │
│  │   ┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐  │    │
│  │   │   ODS   │ ───▶ │   DWD   │ ───▶ │   DWS   │ ───▶ │   ADS   │  │    │
│  │   │  原始层 │      │  明细层 │      │  汇总层 │      │  应用层 │  │    │
│  │   └─────────┘      └─────────┘      └─────────┘      └─────────┘  │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    ClickHouse / Doris 集群                           │    │
│  │                                                                     │    │
│  │   ┌────────────────────────────────────────────────────────────┐   │    │
│  │   │                    查询路由层                              │   │    │
│  │   │           (Load Balancer / Query Router)                   │   │    │
│  │   └──────────────────────────┬─────────────────────────────────┘   │    │
│  │                              │                                       │    │
│  │       ┌──────────────────────┼──────────────────────┐               │    │
│  │       │                      │                      │               │    │
│  │       ▼                      ▼                      ▼               │    │
│  │  ┌─────────┐           ┌─────────┐           ┌─────────┐          │    │
│  │  │  Node 1 │           │  Node 2 │           │  Node N │          │    │
│  │  │ (Server)│           │ (Server)│           │ (Server)│          │    │
│  │  │         │           │         │           │         │          │    │
│  │  │  ┌────┐ │           │  ┌────┐ │           │  ┌────┐ │          │    │
│  │  │  │CPU │ │           │  │CPU │ │           │  │CPU │ │          │    │
│  │  │  │Disk│ │           │  │Disk│ │           │  │Disk│ │          │    │
│  │  │  │Mem │ │           │  │Mem │ │           │  │Mem │ │          │    │
│  │  │  └────┘ │           │  └────┘ │           │  └────┘ │          │    │
│  │  │         │           │         │           │         │          │    │
│  │  │  Data   │◀─────────▶│  Data   │◀─────────▶│  Data   │          │    │
│  │  │  Shares │  Replica  │  Shares │  Replica  │  Shares │          │    │
│  │  └─────────┘           └─────────┘           └─────────┘          │    │
│  │                                                                     │    │
│  │   ┌────────────────────────────────────────────────────────────┐   │    │
│  │   │                    ZooKeeper / Keeper                      │   │    │
│  │   │              (集群协调 & 元数据管理)                        │   │    │
│  │   └────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                       ClickHouse MergeTree 表引擎                           │
│                                                                             │
│   CREATE TABLE analytics.events (                                          │
│       date Date,                                                           │
│       event_type String,                                                   │
│       user_id UInt64,                                                      │
│       attributes Map(String, String),                                      │
│       created_at DateTime                                                  │
│   ) ENGINE = MergeTree()                                                   │
│   PARTITION BY toYYYYMM(date)                                              │
│   ORDER BY (event_type, date, user_id)                                     │
│   PRIMARY KEY (event_type, date)                                           │
│   SAMPLE BY user_id                                                        │
│   TTL date + INTERVAL 1 YEAR;                                              │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │   数据目录结构 (MergeTree)                                          │   │
│   │                                                                     │   │
│   │   /var/lib/clickhouse/data/                                         │   │
│   │   └─ analytics/                                                     │   │
│   │     └─ events/                                                      │   │
│   │       ├─ 202401_1_100_10/  (Part)                                   │   │
│   │       │  ├─ min_[event_type]_[date].bin                            │   │
│   │       │  ├─ max_[event_type]_[date].bin                            │   │
│   │       │  ├─ primary.idx                                             │   │
│   │       │  └─ data.bin                                                │   │
│   │       ├─ 202402_101_200_15/ (Part)                                  │   │
│   │       └─ 202403_201_300_8/  (Part)                                  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 6. 数据集成架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          数据集成架构                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│  │  关系型数据库   │    │   消息队列      │    │   文件系统      │         │
│  │                 │    │                 │    │                 │         │
│  │  MySQL          │    │  Kafka          │    │  HDFS/S3        │         │
│  │  PostgreSQL     │    │  Pulsar         │    │  MinIO          │         │
│  │  Oracle         │    │  RocketMQ       │    │  Local Files    │         │
│  │  SQL Server     │    │                 │    │                 │         │
│  └────────┬────────┘    └────────┬────────┘    └────────┬────────┘         │
│           │                      │                      │                   │
│           │                      │                      │                   │
│           ▼                      ▼                      ▼                   │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    CDC (Change Data Capture)                        │    │
│  │                                                                     │    │
│  │   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐ │    │
│  │   │  Flink CDC      │    │  Debezium       │    │  Canal          │ │    │
│  │   │                 │    │                 │    │                 │ │    │
│  │   │  - MySQL        │    │  - MySQL        │    │  - MySQL        │ │    │
│  │   │  - PostgreSQL   │    │  - PostgreSQL   │    │  - Oracle       │ │    │
│  │   │  - MongoDB      │    │  - MongoDB      │    │  - Redis        │ │    │
│  │   │  - Oracle       │    │  - SQL Server   │    │                 │ │    │
│  │   └─────────────────┘    └─────────────────┘    └─────────────────┘ │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    数据同步工具                                       │    │
│  │                                                                     │    │
│  │   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐ │    │
│  │   │   Apache DataX  │    │   SeaTunnel     │    │   Apache Sqoop  │ │    │
│  │   │                 │    │                 │    │                 │ │    │
│  │   │  - 阿里开源     │    │  - 统一数据同步 │    │  - Hadoop 生态  │ │    │
│  │   │  - 离线同步     │    │  - CDC 支持     │    │  - 关系型数据库 │ │    │
│  │   │  - 插件化架构   │    │  - Spark/Flink  │    │  - HDFS         │ │    │
│  │   └─────────────────┘    └─────────────────┘    └─────────────────┘ │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    目标存储 (Data Lake / Warehouse)                  │    │
│  │                                                                     │    │
│  │   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐ │    │
│  │   │   数据湖        │    │   数据仓库      │    │   OLAP 引擎     │ │    │
│  │   │                 │    │                 │    │                 │ │    │
│  │   │  Apache Iceberg │    │  Apache Hive    │    │  ClickHouse     │ │    │
│  │   │  Apache Hudi    │    │  Apache Doris   │    │  Apache Doris   │ │    │
│  │   │  Delta Lake     │    │  Apache Spark   │    │  Apache Druid   │ │    │
│  │   │                 │    │  Snowflake      │    │  StarRocks      │ │    │
│  │   └─────────────────┘    └─────────────────┘    └─────────────────┘ │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 7. 数据流模式

### 7.1 实时数据仓库

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        实时数据仓库 (Real-time DWH)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   数据源            实时处理            ODS            DWD            DWS    │
│                                                                             │
│  ┌────────┐                                                         ┌────────┐│
│  │  APP   │──▶┌────────────┐──▶┌────────────┐──▶┌────────────┐──▶│  OLAP  ││
│  │  Logs  │   │    Kafka   │   │  Flink SQL │   │  Flink SQL │   │ Doris  ││
│  └────────┘   │  (ods_raw) │   │   (ODS)    │   │   (DWD)    │   │        ││
│               └────────────┘   └────────────┘   └────────────┘   │  Click-││
│  ┌────────┐                       │                    │         │  House ││
│  │  DB    │──▶┌────────────┐──▶┌──┴──┐       ┌────────┴──┐      │        ││
│  │  CDC   │   │  Flink CDC │   │Kafka│       │   Kafka   │      └────────┘│
│  └────────┘   └────────────┘   │(dwd)│       │  (dws_ad) │                │
│                                └─────┘       └───────────┘                │
│                                   │                    │                   │
│                                   ▼                    ▼                   │
│                          ┌─────────────┐      ┌─────────────┐              │
│                          │  Flink CEP  │      │  Aggregation│              │
│                          │  (实时告警)  │      │  (实时汇总)  │              │
│                          └─────────────┘      └─────────────┘              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 Lambda 架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Lambda 架构                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                         ┌─────────────────┐                                  │
│                         │    Batch View   │                                  │
│                         │    (批处理层)    │                                  │
│                         │                 │                                  │
│                         │  Spark Batch    │                                  │
│                         │  24小时/1小时    │                                  │
│                         │  聚合计算        │                                  │
│                         └────────┬────────┘                                  │
│                                  │                                          │
│                         ┌────────┴────────┐                                  │
│                         │                 │                                  │
│                         ▼                 ▼                                  │
│              ┌──────────────────┐  ┌──────────────────┐                      │
│              │ Serving Layer    │  │  Speed Layer     │                      │
│              │ (服务层)         │  │  (速度层)        │                      │
│              │                  │  │                  │                      │
│              │  查询合并        │  │  Flink Streaming │                      │
│              │  Batch + Speed  │  │  实时增量计算    │                      │
│              └──────────────────┘  └──────────────────┘                      │
│                                  │                                          │
│                                  ▼                                          │
│                        ┌──────────────────┐                                 │
│                        │   Query API      │                                 │
│                        │   (查询接口)     │                                 │
│                        │                  │                                 │
│                        │  JDBC / HTTP     │                                 │
│                        │  / REST API      │                                 │
│                        └──────────────────┘                                 │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                           数据源                                             │
│   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────┐ │
│   │  Web     │  │ Mobile   │  │  IoT     │  │  Logs    │  │  Database    │ │
│   │  Events  │  │  App     │  │ Sensors  │  │          │  │  Changes     │ │
│   └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └──────┬───────┘ │
│        │             │             │             │                 │         │
│        └─────────────┴─────────────┴─────────────┴─────────────────┘         │
│                                    │                                        │
│                                    ▼                                        │
│                          ┌──────────────────┐                               │
│                          │   Master Dataset │                               │
│                          │   (原始数据湖)    │                               │
│                          │   (HDFS/S3)      │                               │
│                          └──────────────────┘                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 8. 监控运维架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          监控运维架构                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                        指标采集 (Metrics)                           │    │
│  │                                                                     │    │
│  │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │    │
│  │   │  Prometheus     │  │  Telegraf       │  │  Fluentd        │    │    │
│  │   │                 │  │                 │  │                 │    │    │
│  │   │  - Pull metrics │  │  - System stats │  │  - Log collect │    │    │
│  │   │  - Time series │  │  - Docker       │  │  - Log forward │    │    │
│  │   │  - Alert rules │  │  - Kafka        │  │                 │    │    │
│  │   └────────┬────────┘  └────────┬────────┘  └────────┬────────┘    │    │
│  │            │                    │                    │              │    │
│  │            └────────────────────┼────────────────────┘              │    │
│  │                                 │                                    │    │
│  └─────────────────────────────────┼────────────────────────────────────┘    │
│                                    │                                         │
│                                    ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                       监控可视化 (Visualization)                     │    │
│  │                                                                     │    │
│  │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │    │
│  │   │   Grafana       │  │   Kibana        │  │   AlertManager  │    │    │
│  │   │                 │  │                 │  │                 │    │    │
│  │   │  - Dashboards   │  │  - Log search   │  │  - Alert rules  │    │    │
│  │   │  - Visualize    │  │  - Log analyze  │  │  - Notification│    │    │
│  │   │  - Explore      │  │  - Metrics      │  │  - Silence      │    │    │
│  │   └─────────────────┘  └─────────────────┘  └─────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                       告警通知 (Alerting)                            │    │
│  │                                                                     │    │
│  │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │    │
│  │   │     Email       │  │     Slack       │  │   PagerDuty     │    │    │
│  │   └─────────────────┘  └─────────────────┘  └─────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                         组件监控指标                                         │
│                                                                             │
│   ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐        │
│   │  Kafka   │ │  Flink   │ │  Spark   │ │ ClickHouse││  Doris   │        │
│   ├──────────┼ ├──────────┼ ├──────────┼ ├───────────┼┼──────────┤        │
│   │ Under-   │ │ Checkpnt │ │ Stages   │ │ QPS       ││ BE CPU   │        │
│   │ replic   │ │ Duration │ │ Failed   │ │ Latency   ││ FE QPS   │        │
│   │ Lag      │ │ Backpres │ │ Tasks    │ │ Mem       ││ Disk IO  │        │
│   │ Bytes-in │ │ NumTasks │ │ Execs    │ │ Repl Rate ││ Rep      │        │
│   │ ISR      │ │ SentBytes│ │ Shuffle  │ │ MergeCnt  ││ Tablet   │        │
│   └──────────┘ └──────────┘ └──────────┘ └───────────┘└──────────┘        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```
