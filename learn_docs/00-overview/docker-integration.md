# Docker 环境组件集成图

本文档展示大数据平台在 Docker 环境下的组件部署和集成关系。

## 1. 完整集群部署架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Docker Network: bigdata                            │
│                           192.168.1.0/24 (自定义网络)                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                         协调服务 (Coordination)                           │  │
│  │                                                                           │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐           │  │
│  │  │   Zookeeper 1   │  │   Zookeeper 2   │  │   Zookeeper 3   │           │  │
│  │  │  :2181          │  │  :2181          │  │  :2181          │           │  │
│  │  │  :2888          │  │  :2888          │  │  :2888          │           │  │
│  │  │  :3888          │  │  :3888          │  │  :3888          │           │  │
│  │  │  zookeeper-1    │  │  zookeeper-2    │  │  zookeeper-3    │           │  │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘           │  │
│  │                                                                           │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                         消息队列 (Message Queue)                          │  │
│  │                                                                           │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                       Kafka Cluster                                │  │  │
│  │  │                                                                       │  │  │
│  │  │   ┌───────────────┐   ┌───────────────┐   ┌───────────────┐        │  │  │
│  │  │   │   Kafka-1     │   │   Kafka-2     │   │   Kafka-3     │        │  │  │
│  │  │   │   :9092       │   │   :9092       │   │   :9092       │        │  │  │
│  │  │   │               │   │               │   │               │        │  │  │
│  │  │   │  - Broker ID  │   │  - Broker ID  │   │  - Broker ID  │        │  │  │
│  │  │   │    = 1        │   │    = 2        │   │    = 3        │        │  │  │
│  │  │   │  - Controller │   │  - Follower   │   │  - Follower   │        │  │  │
│  │  │   └───────────────┘   └───────────────┘   └───────────────┘        │  │  │
│  │  │                                                                       │  │  │
│  │  │   Topic: raw_logs, ods_orders, dwd_events, metrics, alerts          │  │  │
│  │  └─────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                           │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                        流处理 (Stream Processing)                         │  │
│  │                                                                           │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                      Flink Cluster                                  │  │  │
│  │  │                                                                       │  │  │
│  │  │   ┌───────────────────┐   ┌───────────────────┐                     │  │  │
│  │  │   │  JobManager       │   │  TaskManager (x3) │                     │  │  │
│  │  │   │  :8081            │   │  :{random}        │                     │  │  │
│  │  │   │                   │   │                   │                     │  │  │
│  │  │   │  - Resource Mgmt  │   │  - Task Slots: 4  │                     │  │  │
│  │  │   │  - Job Scheduling │   │  - Memory: 2GB    │                     │  │  │
│  │  │   │  - REST API       │   │  - Parallelism    │                     │  │  │
│  │  │   └───────────────────┘   └───────────────────┘                     │  │  │
│  │  │                                                                       │  │  │
│  │  │   Jobs:                                                              │  │  │
│  │  │   - orders-etl (Kafka → Doris)                                      │  │  │
│  │  │   - metrics-agg (Real-time KPIs)                                    │  │  │
│  │  │   - alert-engine (CEP)                                              │  │  │
│  │  └─────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                           │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                          OLAP 数据库 (OLAP Databases)                     │  │
│  │                                                                           │  │
│  │  ┌───────────────────┐  ┌─────────────────────────────────────────────┐  │  │
│  │  │   ClickHouse      │  │              Apache Doris                   │  │  │
│  │  │   :8123           │  │                                             │  │  │
│  │  │   :9000           │  │  ┌───────────────────┐  ┌────────────────┐ │  │  │
│  │  │                   │  │  │  FE (Frontend)    │  │  BE (Backend)  │ │  │  │
│  │  │  - MergeTree      │  │  │  :8030            │  │  :9050 (x3)    │ │  │  │
│  │  │  - Replicated     │  │  │  :8033            │  │                │ │  │  │
│  │  │  - Distributed    │  │  │                   │  │  - Data Storage│ │  │  │
│  │  └───────────────────┘  │  │  - Query Parsing  │  │  - Compaction  │ │  │  │
│  │                         │  │  - Planning       │  │  - Execution   │ │  │  │
│  │  Tables:                │  │  - Coord          │  │                │ │  │  │
│  │  - events_analytics     │  └───────────────────┘  └────────────────┘ │  │  │
│  │  - user_behavior        │  ┌────────────────────────────────────────┐ │  │  │
│  │  - metrics_dashboard    │  │  FE HA: 3 Frontends (8030, 8031, 8032)│ │  │  │
│  │                         │  │  BE: 3 Backends (9050, 9051, 9052)    │ │  │  │
│  │                         │  │  Broker: 3 Brokers (8480, 8481, 8482)  │ │  │  │
│  │                         │  └────────────────────────────────────────┘ │  │  │
│  │                         └─────────────────────────────────────────────┘  │  │
│  │                                                                           │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                         缓存 & 搜索 (Cache & Search)                      │  │
│  │                                                                           │  │
│  │  ┌───────────────────┐  ┌───────────────────┐  ┌───────────────────┐    │  │
│  │  │      Redis        │  │   Elasticsearch   │  │      MySQL        │    │  │
│  │  │      :6379        │  │      :9200        │  │      :3306        │    │  │
│  │  │                   │  │      :5601 (Kibana)│ │      :3307 (root) │    │  │
│  │  │  - Session Store  │  │                   │  │                   │    │  │
│  │  │  - Hot Data       │  │  - Full-text      │  │  - Metadata       │    │  │
│  │  │  - Rate Limit     │  │  - Logs Index     │  │  - Config Store   │    │  │
│  │  │  - Pub/Sub        │  │  - Metrics        │  │  - User Data      │    │  │
│  │  └───────────────────┘  └───────────────────┘  └───────────────────┘    │  │
│  │                                                                           │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                        监控 & 日志 (Observability)                        │  │
│  │                                                                           │  │
│  │  ┌───────────────────┐  ┌───────────────────┐  ┌───────────────────┐    │  │
│  │  │    Prometheus     │  │      Grafana      │  │    Alertmanager   │    │  │
│  │  │      :9090        │  │      :3000        │  │      :9093        │    │  │
│  │  │                   │  │                   │  │                   │    │  │
│  │  │  - Metrics Store  │  │  - Dashboards     │  │  - Alert Routing  │    │  │
│  │  │  - Scrape Config  │  │  - Visualization  │  │  - Silence        │    │  │
│  │  │  - Alert Rules    │  │  - Alerts View    │  │  - Integration    │    │  │
│  │  └───────────────────┘  └───────────────────┘  └───────────────────┘    │  │
│  │                                                                           │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                        数据集成 (Data Integration)                        │  │
│  │                                                                           │  │
│  │  ┌───────────────────┐  ┌───────────────────┐  ┌───────────────────┐    │  │
│  │  │    DataX          │  │    SeaTunnel      │  │    CDC Connectors │    │  │
│  │  │    :5000          │  │    :5001          │  │                   │    │  │
│  │  │                   │  │                   │  │  - Flink CDC      │    │  │
│  │  │  - Batch Sync     │  │  - Unified Sync   │  │  - Debezium       │    │  │
│  │  │  - Plugin Based   │  │  - Streaming      │  │  - Maxwell        │    │  │
│  │  └───────────────────┘  └───────────────────┘  └───────────────────┘    │  │
│  │                                                                           │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 2. 数据流向图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              数据流向 (Data Flow)                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  外部数据源                                                                      │
│                                                                                 │
│    │                                                                             │
│    │                                                                             │
│    ▼                                                                             │
│  ┌────────────────┐    ┌────────────────┐    ┌────────────────┐                 │
│  │  Application   │    │   IoT Devices  │    │    Web Logs    │                 │
│  │  Logs          │    │   Sensors      │    │    (Files)     │                 │
│  └───────┬────────┘    └───────┬────────┘    └───────┬────────┘                 │
│          │                    │                    │                           │
│          └────────────────────┼────────────────────┘                           │
│                               │                                                 │
│                               ▼                                                 │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                          日志采集 (Log Collection)                       │  │
│  │                                                                          │  │
│  │   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐                │  │
│  │   │   Filebeat   │   │   Fluentd    │   │   Logstash   │                │  │
│  │   │              │   │              │   │              │                │  │
│  │   │  - Tail Files│   │  - Tag Logs  │   │  - Pipeline  │                │  │
│  │   │  - JSON Parse│   │  - Filter    │   │  - Transform │                │  │
│  │   └──────┬───────┘   └──────┬───────┘   └──────┬───────┘                │  │
│  │          │                  │                  │                          │  │
│  │          └──────────────────┼──────────────────┘                          │  │
│  │                             │                                               │  │
│  └─────────────────────────────┼─────────────────────────────────────────────┘  │
│                                │                                                │
│                                ▼                                                │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                     消息队列 (Kafka)                                     │  │
│  │                                                                          │  │
│  │   ┌──────────────────────────────────────────────────────────────────┐  │  │
│  │   │  Topic:                                                         │  │  │
│  │   │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐  │  │  │
│  │   │  │ raw     │ │ ods     │ │ dwd     │ │ dws     │ │ ads     │  │  │  │
│  │   │  │ logs    │ │ orders  │ │ events  │ │ metrics │ │ reports │  │  │  │
│  │   │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘  │  │  │
│  │   └──────────────────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                │                                               │
│              ┌─────────────────┼─────────────────┐                            │
│              │                 │                 │                            │
│              ▼                 ▼                 ▼                            │
│  ┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐               │
│  │  Flink Streaming │ │  Flink Streaming │ │  Batch Spark    │               │
│  │  (Real-time ETL) │ │  (Real-time CEP) │ │  (Daily Batch)  │               │
│  │                  │ │                  │ │                  │               │
│  │  - Data Clean    │ │  - Anomaly       │ │  - Full Refresh │               │
│  │  - Data Enrich   │ │    Detection     │ │  - ML Training  │               │
│  │  - Schema Evol   │ │  - Alert Trigger │ │  - Audit        │               │
│  └────────┬─────────┘ └────────┬─────────┘ └────────┬─────────┘               │
│           │                    │                    │                         │
│           └────────────────────┼────────────────────┘                         │
│                                │                                               │
│                                ▼                                               │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                    数据存储 (Data Storage)                               │  │
│  │                                                                          │  │
│  │   ┌──────────────────────────────────────────────────────────────────┐  │  │
│  │   │                                                                  │  │  │
│  │   │   ┌────────────────┐  ┌────────────────┐  ┌────────────────┐    │  │  │
│  │   │   │  ClickHouse    │  │  Apache Doris  │  │  Elasticsearch │    │  │  │
│  │   │   │                │  │                │  │                │    │  │  │
│  │   │   │  - Aggregated  │  │  - Join Query  │  │  - Full-text   │    │  │  │
│  │   │   │    Metrics     │  │  - Dashboard   │  │  - Log Search  │    │  │  │
│  │   │   │  - Event       │  │  - Ad-hoc      │  │  - Tracing     │    │  │  │
│  │   │   │    Analytics   │  │    Query       │  │                │    │  │  │
│  │   │   └────────────────┘  └────────────────┘  └────────────────┘    │  │  │
│  │   │                                                                  │  │  │
│  │   │   ┌────────────────┐  ┌────────────────┐  ┌────────────────┐    │  │  │
│  │   │   │     Redis      │  │      MySQL     │  │      HDFS      │    │  │  │
│  │   │   │                │  │                │  │                │    │  │  │
│  │   │   │  - Cache       │  │  - Metadata    │  │  - Raw Data    │    │  │  │
│  │   │   │  - Session     │  │  - Config      │  │  - Archives    │    │  │  │
│  │   │   │  - Hot Data    │  │  - Users       │  │  - Backups     │    │  │  │
│  │   │   └────────────────┘  └────────────────┘  └────────────────┘    │  │  │
│  │   │                                                                  │  │  │
│  │   └──────────────────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                │                                               │
│                                ▼                                               │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                    数据服务 (Data Service)                               │  │
│  │                                                                          │  │
│  │   ┌────────────────┐  ┌────────────────┐  ┌────────────────┐            │  │
│  │   │   Grafana      │  │   Kibana       │  │   Superset     │            │  │
│  │   │                │  │                │  │                │            │  │
│  │   │  - Dashboards  │  │  - Log Dashbd  │  │  - SQL Editor  │            │  │
│  │   │  - Metrics     │  │  - Analytics   │  │  - Charts      │            │  │
│  │   │  - Alerts      │  │  - Alerts      │  │  - Embed API   │            │  │
│  │   └────────────────┘  └────────────────┘  └────────────────┘            │  │
│  │                                                                          │  │
│  │   ┌────────────────┐  ┌────────────────┐  ┌────────────────┐            │  │
│  │   │   REST API     │  │   GraphQL      │  │   JDBC/ODBC    │            │  │
│  │   │                │  │                │  │                │            │  │
│  │   │  - Data Query  │  │  - Flexible    │  │  - BI Tools    │            │  │
│  │   │  - Auth        │  │  - Schema      │  │  - IDE         │            │  │
│  │   │  - Rate Limit  │  │  - Caching     │  │  - Apps        │            │  │
│  │   └────────────────┘  └────────────────┘  └────────────────┘            │  │
│  │                                                                          │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 3. Docker Compose 服务依赖关系

```yaml
# 服务启动顺序和依赖关系
services:
  # 第一层: 基础依赖
  zookeeper-1: { image: zookeeper, ports: [2181:2181], networks: [bigdata] }
  zookeeper-2: { image: zookeeper, ports: [2181:2181], networks: [bigdata] }
  zookeeper-3: { image: zookeeper, ports: [2181:2181], networks: [bigdata] }

  # 第二层: Kafka (依赖 Zookeeper)
  kafka-1: { image: kafka, depends_on: [zookeeper-1, zookeeper-2, zookeeper-3], ports: [9092:9092] }
  kafka-2: { image: kafka, depends_on: [zookeeper-1, zookeeper-2, zookeeper-3], ports: [9092:9092] }
  kafka-3: { image: kafka, depends_on: [zookeeper-1, zookeeper-2, zookeeper-3], ports: [9092:9092] }

  # 第三层: 数据源和缓存 (独立)
  mysql:     { image: mysql, ports: [3306:3306], networks: [bigdata] }
  redis:     { image: redis, ports: [6379:6379], networks: [bigdata] }
  elasticsearch: { image: elasticsearch, ports: [9200:9200, 5601:5601], networks: [bigdata] }

  # 第四层: OLAP 数据库 (可选依赖 MySQL)
  clickhouse: { image: clickhouse, ports: [8123:8123, 9000:9000], depends_on: [mysql] }
  doris-fe:   { image: doris, depends_on: [mysql], ports: [8030:8030, 8031:8031] }
  doris-be:   { image: doris, depends_on: [doris-fe], ports: [9050:9050] }

  # 第五层: 计算引擎 (依赖 Kafka, 数据源)
  flink-jobmanager: { image: flink, depends_on: [kafka-1, kafka-2, kafka-3], ports: [8081:8081] }
  flink-taskmanager: { image: flink, depends_on: [flink-jobmanager, kafka-1, kafka-2, kafka-3] }

  # 第六层: 监控工具 (依赖所有服务)
  prometheus: { image: prometheus, depends_on: [all services], ports: [9090:9090] }
  grafana:    { image: grafana, depends_on: [prometheus], ports: [3000:3000] }
  alertmanager:{ image: alertmanager, depends_on: [prometheus], ports: [9093:9093] }
```

## 4. 端口映射总览

| 组件 | 容器端口 | 映射端口 | 协议 | 用途 |
|------|----------|----------|------|------|
| Zookeeper | 2181, 2888, 3888 | 2181-2183 | TCP | 集群协调 |
| Kafka | 9092 | 9092-9094 | TCP | 消息队列 |
| Flink | 8081 | 8081 | HTTP | JobManager UI |
| ClickHouse | 8123, 9000 | 8123, 9000 | HTTP/TCP | OLAP 查询 |
| Doris FE | 8030, 8031, 8032 | 8030-8032 | HTTP | 前端协调 |
| Doris BE | 9050, 9051, 9052 | 9050-9052 | TCP | 后端计算 |
| MySQL | 3306 | 3306 | TCP | 关系数据库 |
| Redis | 6379 | 6379 | TCP | 缓存/队列 |
| Elasticsearch | 9200, 5601 | 9200, 5601 | HTTP | 搜索引擎 |
| Prometheus | 9090 | 9090 | HTTP | 监控存储 |
| Grafana | 3000 | 3000 | HTTP | 可视化 |
| Alertmanager | 9093 | 9093 | HTTP | 告警管理 |
