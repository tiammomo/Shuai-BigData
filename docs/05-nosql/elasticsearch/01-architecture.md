# Elasticsearch 架构详解

## 目录

- [概述](#概述)
- [核心概念](#核心概念)
- [架构原理](#架构原理)
- [数据模型](#数据模型)
- [查询模型](#查询模型)

---

## 概述

Elasticsearch 是一个分布式、RESTful 的搜索和分析引擎。

### 核心特性

| 特性 | 说明 |
|------|------|
| **分布式** | 水平扩展 |
| **全文搜索** | 倒排索引 |
| **实时分析** | 聚合查询 |
| **高可用** | 副本机制 |
| **RESTful** | HTTP API |

---

## 核心概念

### 核心术语

```
┌─────────────────────────────────────────────────────────────────┐
│                    Elasticsearch 核心概念                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Index (索引)     │  文档集合，相当于数据库                     │
│  Type (类型)      │  文档类型 (7.x 已移除)                      │
│  Document (文档)  │  基本数据单元                              │
│  Field (字段)     │  文档的属性                                │
│  Mapping (映射)   │  字段类型定义                              │
│  Shard (分片)     │  索引分片                                  │
│  Replica (副本)   │  分片副本                                  │
│  Node (节点)      │  ES 实例                                   │
│  Cluster (集群)   │  节点集合                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 数据类型

| 类型 | 说明 | 示例 |
|------|------|------|
| text | 全文索引 | "content" |
| keyword | 精确值 | "status" |
| long | 64位整数 | 123456789 |
| integer | 32位整数 | 12345 |
| double | 双精度浮点 | 3.14 |
| date | 日期 | "2024-01-10" |
| boolean | 布尔值 | true/false |
| object | 对象 | { "name": "xxx" } |
| nested | 嵌套对象 | 数组对象 |
| geo_point | 地理位置 | {lat, lon} |

---

## 架构原理

### 集群架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    Elasticsearch 集群                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Master Node                           │   │
│  │  - 集群管理                                               │   │
│  │  - 索引管理                                               │   │
│  │  - 分片分配                                               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   Data Node                              │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐                  │   │
│  │  │Shard 0  │  │Shard 1  │  │Shard 2  │                  │   │
│  │  │Replica  │  │Replica  │  │Replica  │                  │   │
│  │  └─────────┘  └─────────┘  └─────────┘                  │   │
│  │  - 数据存储                                               │   │
│  │  - 查询执行                                               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   Coordinating Node                      │   │
│  │  - 请求转发                                               │   │
│  │  - 结果聚合                                               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 分片机制

```
┌─────────────────────────────────────────────────────────────────┐
│                    分片与副本                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Index                                                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Shard 0  ─── Primary ──► Replica 1                      │   │
│  │  Shard 1  ─── Primary ──► Replica 1                      │   │
│  │  Shard 2  ─── Primary ──► Replica 1                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  分片策略:                                                       │
│  - 主分片: 负责写操作                                            │
│  - 副本分片: 负责读操作 (可配置)                                 │
│  - 分片数固定: 创建索引时确定                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 数据模型

### 文档结构

```json
{
  "_index": "products",
  "_type": "_doc",
  "_id": "1",
  "_version": 1,
  "_source": {
    "product_id": 1001,
    "name": "iPhone 15",
    "description": "Apple iPhone 15 智能手机",
    "price": 5999.00,
    "category": "电子产品",
    "tags": ["手机", "Apple", "5G"],
    "attributes": {
      "color": "蓝色",
      "storage": "256GB",
      "screen": "6.1英寸"
    },
    "created_at": "2024-01-10T10:00:00Z",
    "in_stock": true
  }
}
```

### Mapping 定义

```json
{
  "mappings": {
    "properties": {
      "product_id": {
        "type": "long"
      },
      "name": {
        "type": "text",
        "analyzer": "ik_max_word",
        "fields": {
          "keyword": {
            "type": "keyword"
          }
        }
      },
      "description": {
        "type": "text",
        "analyzer": "ik_smart"
      },
      "price": {
        "type": "scaled_float",
        "scaling_factor": 100
      },
      "category": {
        "type": "keyword"
      },
      "tags": {
        "type": "keyword"
      },
      "attributes": {
        "type": "object",
        "properties": {
          "color": { "type": "keyword" },
          "storage": { "type": "keyword" }
        }
      },
      "created_at": {
        "type": "date"
      },
      "in_stock": {
        "type": "boolean"
      }
    }
  }
}
```

---

## 查询模型

### 查询类型

```
┌─────────────────────────────────────────────────────────────────┐
│                    查询类型分类                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  全文查询                                                       │
│  ├── match      - 分词匹配                                      │
│  ├── match_phrase - 短语匹配                                    │
│  ├── multi_match - 多字段匹配                                   │
│  └── query_string - 复杂查询                                    │
│                                                                 │
│  精确查询                                                       │
│  ├── term       - 精确值匹配                                    │
│  ├── terms      - 多值精确匹配                                  │
│  ├── range      - 范围查询                                      │
│  └── exists     - 字段存在检查                                  │
│                                                                 │
│  复合查询                                                       │
│  ├── bool       - 布尔组合                                      │
│  ├── constant_score - 常量分数                                  │
│  └── function_score - 函数分数                                  │
│                                                                 │
│  聚合查询                                                       │
│  ├── metrics    - 指标聚合                                      │
│  ├── bucket     - 桶聚合                                        │
│  └── pipeline   - 管道聚合                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 查询示例

```json
// 全文查询
{
  "query": {
    "match": {
      "name": "iPhone 15"
    }
  }
}

// 布尔查询
{
  "query": {
    "bool": {
      "must": [
        { "match": { "name": "iPhone" } }
      ],
      "should": [
        { "term": { "category": "电子产品" } }
      ],
      "filter": [
        { "range": { "price": { "gte": 5000 } } }
      ]
    }
  }
}

// 聚合查询
{
  "query": { "match_all": {} },
  "size": 0,
  "aggs": {
    "category_stats": {
      "terms": { "field": "category" },
      "aggs": {
        "avg_price": { "avg": { "field": "price" } }
      }
    }
  }
}
```

---

## 相关文档

| 文档 | 说明 |
|------|------|
| [02-data-operations.md](02-data-operations.md) | 数据操作指南 |
| [03-query-guide.md](03-query-guide.md) | 查询指南 |
| [04-optimization.md](04-optimization.md) | 性能优化 |
| [README.md](README.md) | 索引文档 |
