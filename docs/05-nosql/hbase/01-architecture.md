# HBase 架构详解

## 目录

- [概述](#概述)
- [核心概念](#核心概念)
- [架构原理](#架构原理)
- [数据模型](#数据模型)
- [读写流程](#读写流程)

---

## 概述

HBase 是一个分布式的、面向列族的 NoSQL 数据库，基于 Hadoop 构建。

### 核心特性

| 特性 | 说明 |
|------|------|
| **列式存储** | 按列族存储 |
| **高可用** | Master + RegionServer |
| **强一致性** | 行级事务 |
| **水平扩展** | 自动分片 |
| **稀疏数据** | 允许大量空值 |

---

## 核心概念

### 核心术语

```
┌─────────────────────────────────────────────────────────────────┐
│                    HBase 核心概念                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Table          │  表                                          │
│  Column Family  │  列族                                        │
│  Column Qualifier│  列限定符                                   │
│  Row Key        │  行键                                        │
│  Cell           │  单元格 (行键+列族+列限定符+时间戳)           │
│  Version        │  版本                                        │
│                                                                 │
│  Region         │  区域                                        │
│  HFile          │  数据文件                                    │
│  WAL            │  预写日志                                    │
│  MemStore       │  内存缓冲区                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 数据模型

```
┌─────────────────────────────────────────────────────────────────┐
│                    HBase 数据模型                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Row Key │ Column Family: Info          │ Column Family: Data  │
│  ────────┼────────────────────────────────────────────────────  │
│  user001 │ info:name=Alice              │ data:score=95        │
│          │ info:age=25                  │ data:subject=Math    │
│          │ info:email=alice@email.com   │                      │
│  ────────┼────────────────────────────────────────────────────  │
│  user002 │ info:name=Bob                │ data:score=88        │
│          │ info:age=30                  │ data:subject=Science │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 架构原理

### 集群架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    HBase 集群架构                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    HBase Master                          │   │
│  │  - 负责 Region 分配                                      │   │
│  │  - 负责 Schema 管理                                      │   │
│  │  - 监控 RegionServer                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                               │                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              Zookeeper (3/5/7 节点)                      │   │
│  │  - 选主                                                  │   │
│  │  - 服务发现                                              │   │
│  │  - 配置管理                                              │   │
│  │  - 锁服务                                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   RegionServer (多个)                    │   │
│  │  ┌───────────────────────────────────────────────────┐  │   │
│  │  │  Region 1     │  Region 2     │  Region 3        │  │   │
│  │  │  ┌─────────┐  │  ┌─────────┐  │  ┌─────────┐      │  │   │
│  │  │  │MemStore │  │  │MemStore │  │  │MemStore │      │  │   │
│  │  │  └─────────┘  │  └─────────┘  │  └─────────┘      │  │   │
│  │  │  ┌─────────┐  │  ┌─────────┐  │  ┌─────────┐      │  │   │
│  │  │  │  Block  │  │  │  Block  │  │  │  Block  │      │  │   │
│  │  │  │  Cache  │  │  │  Cache  │  │  │  Cache  │      │  │   │
│  │  │  └─────────┘  │  └─────────┘  │  └─────────┘      │  │   │
│  │  │  ┌───────────────────────────────────────────────┐│  │   │
│  │  │  │              HFiles (StoreFiles)              ││  │   │
│  │  │  └───────────────────────────────────────────────┘│  │   │
│  │  └───────────────────────────────────────────────────┘  │   │
│  │  - 数据读写                                              │   │
│  │  - Compaction                                           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    HDFS                                 │   │
│  │  - 数据存储                                              │   │
│  │  - 数据复制                                              │   │
│  │  - WAL 存储                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Region 机制

```
┌─────────────────────────────────────────────────────────────────┐
│                    Region 划分                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Table                                                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Region 1: [aaa - def)                                   │   │
│  │  Region 2: [def - xyz)                                   │   │
│  │  Region 3: [xyz - ~)                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  自动分裂:                                                       │
│  - 当 Region 过大时自动分裂                                      │
│  - 默认 10GB                                                    │
│  - 支持手动分裂                                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 数据模型

### Row Key 设计

```java
// Row Key 原则:
// 1. 唯一性
// 2. 长度适中 (16-100 bytes)
// 3. 字典序排序

// 示例: 用户行为数据
// userId_timestamp_eventType_deviceId

// 示例: 订单数据
// orderId (雪花算法生成)

// 示例: 时间序列数据
// metricType_timestamp
```

### 列族设计

```java
// 列族数量:
// - 不宜过多 (2-3 个)
// - 相关字段放同一列族

// 示例
ColumnFamilyInfo   // 信息字段
ColumnFamilyData   // 数据字段
ColumnFamilyLog    // 日志字段

// 列族配置
// HColumnDescriptor descriptor = new HColumnDescriptor("info");
// descriptor.setMaxVersions(3);           // 最大版本数
// descriptor.setTimeToLive(86400);        // TTL (秒)
// descriptor.setInMemory(true);           // 常驻内存
```

### 版本控制

```java
// 获取指定版本
Get get = new Get(rowKey);
get.setTimeStamp(timestamp);
Result result = table.get(get);

// 获取所有版本
Get get = new Get(rowKey);
get.readAllVersions();
Result result = table.get(get);

// 设置版本数
// 列族级别
// hbase.column-family.max-versions=3

// 单次查询
Get get = new Get(rowKey);
get.setMaxVersions(10);
```

---

## 读写流程

### 写入流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    HBase 写入流程                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 客户端请求 Zookeeper 获取 Meta 表位置                        │
│  2. 客户端请求 RegionServer 获取 RowKey 所在的 Region            │
│  3. 数据写入 RegionServer:                                       │
│     a) 写入 WAL (预写日志)                                       │
│     b) 写入 MemStore (内存)                                      │
│  4. MemStore 满了后 flush 为 HFile                               │
│  5. 异步执行 Compaction 合并文件                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 读取流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    HBase 读取流程                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 客户端请求 Zookeeper 获取 Meta 表位置                        │
│  2. 客户端查询 RegionServer                                      │
│  3. RegionServer 查询数据:                                       │
│     a) 查找 BlockCache                                           │
│     b) 查找 MemStore                                             │
│     c) 扫描 HFiles                                              │
│  4. 返回结果 (按时间戳倒序)                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 相关文档

| 文档 | 说明 |
|------|------|
| [02-data-operations.md](02-data-operations.md) | 数据操作指南 |
| [03-java-api.md](03-java-api.md) | Java API |
| [04-optimization.md](04-optimization.md) | 性能优化 |
| [README.md](README.md) | 索引文档 |
