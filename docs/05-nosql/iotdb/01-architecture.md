# IoTDB 架构详解

## 目录

- [概述](#概述)
- [核心概念](#核心概念)
- [数据模型](#数据模型)
- [架构原理](#架构原理)
- [存储机制](#存储机制)

---

## 概述

IoTDB (Internet of Things Database) 是专为物联网时序数据设计的数据库。

### 核心特性

| 特性 | 说明 |
|------|------|
| **时序优化** | 专为 IoT 数据优化 |
| **高效写入** | 高吞吐低延迟 |
| **丰富查询** | 时序专用查询 |
| **云边协同** | 支持边缘部署 |
| **工业级** | 稳定可靠 |

---

## 核心概念

### 核心术语

```
┌─────────────────────────────────────────────────────────────────┐
│                    IoTDB 核心概念                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Database    │  数据库，相当于命名空间                          │
│  Storage Group│  存储组，数据分区                               │
│  Device      │  设备实体                                       │
│  Measurement │  传感器/测点                                     │
│  Time Series │  时间序列                                       │
│  Path        │  路径 (SG.D.M)                                  │
│  Schema      │  元数据                                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 数据模型

### 树形结构

```
┌─────────────────────────────────────────────────────────────────┐
│                    IoTDB 数据模型                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  root                                                            │
│  └── vehicle                                                     │
│      ├── engine                                                  │
│      │   ├── temperature (测点1)                                 │
│      │   ├── pressure    (测点2)                                 │
│      │   └── vibration   (测点3)                                 │
│      └── wheel                                                        │
│          ├── speed        (测点4)                                │
│          └── temperature   (测点5)                               │
│                                                                 │
│  完整路径示例:                                                    │
│  root.vehicle.engine.temperature                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 数据类型

| 类型 | 说明 | 范围 |
|------|------|------|
| INT32 | 32位整数 | -2^31 ~ 2^31-1 |
| INT64 | 64位整数 | -2^63 ~ 2^63-1 |
| FLOAT | 单精度浮点 | 7位有效数字 |
| DOUBLE | 双精度浮点 | 15位有效数字 |
| BOOLEAN | 布尔值 | true/false |
| TEXT | 字符串 | 任意字符串 |
| ENUM8 | 枚举值 | 指定枚举 |

---

## 架构原理

### 集群架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    IoTDB 集群架构                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    ConfigNode                            │   │
│  │  - 集群管理                                               │   │
│  │  - 元数据管理                                             │   │
│  │  - 负载均衡                                               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                               │                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    DataNode (多个)                       │   │
│  │  ┌───────────────────────────────────────────────────┐  │   │
│  │  │  Write Ahead Log (WAL)                            │  │   │
│  │  │  ┌─────────────────────────────────────────────┐  │  │   │
│  │  │  │         顺序写日志                          │  │  │   │
│  │  │  └─────────────────────────────────────────────┘  │  │   │
│  │  │  SequentialFileGroup                              │  │   │
│  │  │  ┌─────────┐  ┌─────────┐  ┌─────────┐           │  │   │
│  │  │  │TsFile   │  │TsFile   │  │TsFile   │           │  │   │
│  │  │  │ (数据)  │  │ (数据)  │  │ (数据)  │           │  │   │
│  │  │  └─────────┘  └─────────┘  └─────────┘           │  │   │
│  │  └───────────────────────────────────────────────────┘  │   │
│  │  - 数据存储                                               │   │
│  │  - 查询执行                                               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 数据分区

```
┌─────────────────────────────────────────────────────────────────┐
│                    数据分区策略                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  按存储组分区:                                                   │
│  root.vehicle/    ->  存储组 1                                  │
│  root.building/   ->  存储组 2                                  │
│                                                                 │
│  按时间分区:                                                     │
│  TsFile: 2024-01-10-00:00:00-0000.tsfg                         │
│  TsFile: 2024-01-11-00:00:00-0000.tsfg                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 存储机制

### TsFile 结构

```
┌─────────────────────────────────────────────────────────────────┐
│                    TsFile 结构                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Magic Number (8 bytes)                                 │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │  Schema (元数据区域)                                     │   │
│  │  ├── Chunk Group Header                                 │   │
│  │  └── Measurement Schema                                 │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │  Data Region (数据区域)                                  │   │
│  │  ├── Chunk Group 1                                      │   │
│  │  │   └── Chunk (Measurement 1)                          │   │
│  │  ├── Chunk Group 2                                      │   │
│  │  └── ...                                                 │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │  Index Region (索引区域)                                 │   │
│  │  ├── Index of Chunk Group                               │   │
│  │  └── Bloom Filter                                       │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │  Footer (12 bytes)                                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 数据写入

```java
// IoTDB JDBC 写入
Connection connection = DriverManager.getConnection(
    "jdbc:iotdb://localhost:6667/", "root", "root"
);

Statement statement = connection.createStatement();

// 插入单条
statement.execute(
    "INSERT INTO root.vehicle.engine(timestamp, temperature) " +
    "VALUES(1704880800000, 25.5)"
);

// 批量插入
statement.execute(
    "INSERT INTO root.vehicle.engine(timestamp, temperature, pressure) " +
    "VALUES(1704880800000, 25.5, 101.3), " +
    "      (1704880850000, 26.0, 101.5)"
);

// 使用 Session 批量写入
SessionDataSet sessionDataSet = session.insertRecord(
    "root.vehicle.engine",
    1704880800000L,
    Arrays.asList("temperature", "pressure"),
    Arrays.asList(TSDataType.FLOAT, TSDataType.DOUBLE),
    Arrays.asList(25.5f, 101.3)
);
```

---

## 相关文档

| 文档 | 说明 |
|------|------|
| [02-data-operations.md](02-data-operations.md) | 数据操作指南 |
| [03-query-guide.md](03-query-guide.md) | 查询指南 |
| [04-java-api.md](04-java-api.md) | Java API |
| [README.md](README.md) | 索引文档 |
