# Apache Pulsar 架构详解

## 目录

- [概述](#概述)
- [核心概念](#核心概念)
- [架构原理](#架构原理)
- [消息模型](#消息模型)
- [存储机制](#存储机制)

---

## 概述

Apache Pulsar 是一个分布式发布订阅消息系统。

### 核心特性

| 特性 | 说明 |
|------|------|
| **高吞吐** | 百万级 TPS |
| **低延迟** | 毫秒级延迟 |
| **多租户** | 命名空间隔离 |
| **持久化** | 多副本存储 |
| **跨地域** | 多集群复制 |

---

## 核心概念

### 核心术语

```
┌─────────────────────────────────────────────────────────────────┐
│                    Pulsar 核心概念                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Tenant     │  租户                                            │
│  Namespace  │  命名空间                                        │
│  Topic      │  主题                                            │
│  Partition  │  分区                                            │
│  Subscription│  订阅                                           │
│  Producer   │  生产者                                          │
│  Consumer   │  消费者                                          │
│  Cursor     │  消费游标                                        │
│  Ack        │  确认                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 架构原理

### 集群架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    Pulsar 集群架构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Broker                                │   │
│  │  ┌───────────────────────────────────────────────────┐  │   │
│  │  │  Load Balancer │  Dispatcher │  Manager          │  │   │
│  │  └───────────────────────────────────────────────────┘  │   │
│  │  - 消息路由                                              │   │
│  │  - 负载均衡                                              │   │
│  │  - 消费者管理                                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    BookKeeper                            │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐                  │   │
│  │  │Bookie 1 │  │Bookie 2 │  │Bookie 3 │                  │   │
│  │  │(存储)   │  │(存储)   │  │(存储)   │                  │   │
│  │  └─────────┘  └─────────┘  └─────────┘                  │   │
│  │  - 消息持久化                                            │   │
│  │  - 多副本                                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    ZooKeeper                             │   │
│  │  - 配置管理                                              │   │
│  │  - 选举                                                  │   │
│  │  - 协调                                                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 消息模型

### 消息语义

| 类型 | 说明 |
|------|------|
| Exclusive | 独占消费 |
| Shared | 共享消费 |
| Failover | 故障转移 |

### 消息保留

```properties
# 保留策略
# 默认保留 7 天
retentionTimeInMinutes=10080

# 大小限制
retentionSizeInMB=102400

# TTL
messageTTLInSeconds=86400
```

---

## 相关文档

| 文档 | 说明 |
|------|------|
| [02-producer.md](02-producer.md) | 生产者指南 |
| [03-consumer.md](03-consumer.md) | 消费者指南 |
| [04-functions.md](04-functions.md) | Pulsar Functions |
| [README.md](README.md) | 索引文档 |
