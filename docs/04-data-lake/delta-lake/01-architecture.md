# Delta Lake 架构详解

## 目录

- [概述](#概述)
- [核心概念](#核心概念)
- [架构原理](#架构原理)
- [事务机制](#事务机制)
- [存储结构](#存储结构)

---

## 概述

Delta Lake 是基于 Spark 的开源存储层，提供 ACID 事务能力。

### 核心特性

| 特性 | 说明 |
|------|------|
| **ACID** | 事务支持 |
| **Schema 强制** | 数据质量保障 |
| **时间旅行** | 历史版本查询 |
| **UPSERT** | 合并插入更新 |
| **流批一体** | 统一处理 |

---

## 核心概念

### 核心术语

| 术语 | 说明 |
|------|------|
| **Transaction Log** | 事务日志 |
| **Checkpoint** | 检查点 |
| **Version** | 数据版本 |
| **ACID Transaction** | ACID 事务 |
| **Merge-on-Read** | 读取时合并 |

---

## 架构原理

```
┌─────────────────────────────────────────────────────────────────┐
│                      Delta Lake 架构                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Spark Engine                            │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐                    │  │
│  │  │Batch    │  │Streaming│  │ ML      │                    │  │
│  │  │Processing│  │  (Kafka)│  │         │                    │  │
│  │  └─────────┘  └─────────┘  └─────────┘                    │  │
│  └───────────────────────────────────────────────────────────┘  │
│                           │                                    │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Delta Lake (存储层)                     │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐                    │  │
│  │  │Log      │  │ Parquet │  │  JSON   │                    │  │
│  │  │(事务日志)│  │(数据文件)│  │(元数据) │                    │  │
│  │  └─────────┘  └─────────┘  └─────────┘                    │  │
│  └───────────────────────────────────────────────────────────┘  │
│                           │                                    │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Storage (HDFS/S3/ADLS)                  │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 事务机制

### ACID 保证

```scala
// Delta Lake 事务保证
// 1. 原子性 - 整个操作要么成功要么失败
// 2. 一致性 - 始终保持数据一致性
// 3. 隔离性 - 并发操作互不干扰
// 4. 持久性 - 提交后数据不会丢失
```

### 事务日志

```scala
// 事务日志结构
// _delta_log/
// ├── 00000000000000000000.json  (初始事务记录)
// ├── 00000000000000000001.json  (第二次操作)
// ├── 00000000000000000002.json  (第三次操作)
// └── ...
//
// 每个 JSON 文件记录:
// - 添加的文件
// - 删除的文件
// - 元数据变更
// - 协议变更
```

---

## 存储结构

### 文件布局

```
/delta-table/
├── _delta_log/
│   ├── 00000000000000000000.json
│   ├── 00000000000000000001.json
│   └── 00000000000000000002.checkpoint.parquet
├── part-00000-xxx.parquet
├── part-00001-xxx.parquet
└── part-00002-xxx.parquet
```

### 数据文件

```scala
// Parquet 文件特点
// - 列式存储
// - 高压缩比
// - 支持谓词下推
// - 支持列裁剪
```

---

## 相关文档

| 文档 | 说明 |
|------|------|
| [02-data-operations.md](02-data-operations.md) | 数据操作指南 |
| [03-spark-integration.md](03-spark-integration.md) | Spark 集成 |
| [README.md](README.md) | 索引文档 |
