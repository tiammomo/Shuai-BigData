# Apache Iceberg 架构详解

## 目录

- [概述](#概述)
- [核心概念](#核心概念)
- [架构原理](#架构原理)
- [元数据管理](#元数据管理)
- [存储结构](#存储结构)

---

## 概述

Apache Iceberg 是一个开放的数据湖表格式，支持 Schema 演进、时间旅行和跨引擎一致性。

### 核心特性

| 特性 | 说明 |
|------|------|
| **ACID** | 完整事务支持 |
| **模式演进** | 支持 Schema 变更 |
| **时间旅行** | 查询历史版本 |
| **流批一体** | 支持流式写入和批处理 |
| **跨引擎** | Spark, Flink, Hive, Trino |

---

## 核心概念

### 核心术语

| 术语 | 说明 |
|------|------|
| **Table** | Iceberg 表 |
| **Metadata** | 元数据文件 |
| **Manifest** | 清单文件 |
| **Data File** | 数据文件 (Parquet/ORC) |
| **Snapshot** | 快照版本 |
| **Branch** | 分支 |

---

## 架构原理

```
┌─────────────────────────────────────────────────────────────────┐
│                      Iceberg 架构                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Query Engines                           │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐      │  │
│  │  │  Spark  │  │  Flink  │  │  Hive   │  │ Trino   │      │  │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘      │  │
│  └───────────────────────────────────────────────────────────┘  │
│                           │                                    │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Iceberg Table Format                    │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐                    │  │
│  │  │ Metadata│  │Manifest │  │  Data   │                    │  │
│  │  │  File   │  │  Files  │  │  Files  │                    │  │
│  │  └─────────┘  └─────────┘  └─────────┘                    │  │
│  └───────────────────────────────────────────────────────────┘  │
│                           │                                    │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Storage (S3/HDFS/OSS)                   │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 元数据管理

### 元数据文件

```json
{
  "format-version": 2,
  "table-uuid": "uuid",
  "location": "s3://bucket/table",
  "last-updated-ms": 1704931200000,
  "last-column-id": 100,
  "schema": {
    "type": "struct",
    "schema-id": 0,
    "fields": [...]
  },
  "partition-spec": [...],
  "sort-orders": [...],
  "current-snapshot-id": 123456789,
  "snapshots": [...]
}
```

### Manifest 列表

```
┌─────────────────────────────────────────────────────────────────┐
│                     Manifest List                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  每个快照包含一个 Manifest List:                                │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  manifest-list.json                                     │   │
│  │  ├── manifest1.avro (Data Files + Delete Files)         │   │
│  │  ├── manifest2.avro                                     │   │
│  │  └── manifest3.avro                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 存储结构

### 文件布局

```
/iceberg-table/
├── metadata/
│   ├── v1.metadata.json
│   ├── v2.metadata.json
│   ├── v3.metadata.json
│   └── snap-123456789.metadata.json
├── data/
│   ├── year=2024/
│   │   └── month=01/
│   │       └── day=10/
│   │           ├── data-00001.parquet
│   │           └── data-00002.parquet
│   └── year=2024/
│       └── month=01/
│           └── day=11/
│               └── data-00001.parquet
└── log/
    └── 00001-00001-delete-00001.parquet
```

### 数据文件格式

```
┌─────────────────────────────────────────────────────────────────┐
│                     Data Files                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  支持格式:                                                       │
│  - Parquet (列式存储，推荐)                                     │
│  - ORC (列式存储)                                               │
│  - Avro (行式存储)                                              │
│                                                                 │
│  文件特性:                                                       │
│  - 包含 Iceberg Schema 信息                                     │
│  - 包含列统计信息                                               │
│  - 支持谓词下推                                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 相关文档

| 文档 | 说明 |
|------|------|
| [02-data-operations.md](02-data-operations.md) | 数据操作指南 |
| [03-spark-integration.md](03-spark-integration.md) | Spark 集成 |
| [04-flink-integration.md](04-flink-integration.md) | Flink 集成 |
| [README.md](README.md) | 索引文档 |
